<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NeuroVoz - Gravador Inteligente</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #1c8077, #259e7a);
      color: #fff;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }
    .modal-body { color: #333; }
    .modal-body h1, .modal-body h2, .modal-body h3, .modal-body h4, .modal-body h5, .modal-body h6, .modal-body p, .modal-body label { color: #333; }
    h2, h3 { font-weight: 700; text-align: center; }

    .logo {
      width: 100px;
      margin: 15px;
    }
    .card {
      /* <<< MUDANÇA AQUI: Aumentando a largura >>> */
      width: 95%; /* Ocupa 95% da largura disponível */
      max-width: 1400px; /* Mas no máximo 1200px */
      margin: 0 auto;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      background: #fff;
      color: #333;
      border: none;
    }
    button {
      border-radius: 50px;
      font-weight: 600;
      padding: 10px 20px;
      transition: transform 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5em;
    }
    button:hover { transform: scale(1.05); }
    #timer { font-weight: bold; font-size: 1.2rem; margin-left: 15px; color: #1e7248; }
    #visualizer { width: 100%; height: 100px; background: #f1f1f1; border-radius: 12px; }
    textarea { border-radius: 12px; resize: none; box-shadow: inset 0 3px 8px rgba(0,0,0,0.1); }

    .section-title {
        color: #6c757d;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        text-align: center;
    }
     hr {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
     }
    .spinner-beside {
        margin-left: 8px;
    }
  </style>
</head>
<body>

  <div class="container-fluid">

    <div class="card mt-4">
      <div class="card-body d-flex flex-column">

        <div class="text-center mb-4 position-relative"> <img src="logo.png" alt="NeuroVoz Logo" class="logo mb-2">
  <h1 class="h4 d-inline-block" style="color: #1e3c72;">NeuroVoz: Gravador Inteligente</h1>
  
  <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle position-absolute top-0 end-0 m-2" id="tutorialBtn" title="Como usar?">
    <i class="bi bi-question-lg"></i>
  </button>
  </div>

        <hr>

        <h5 class="section-title">1. Grave ou Envie seu Áudio</h5>
        <div class="d-flex flex-wrap justify-content-center align-items-center mb-4 gap-2">
          <button id="recordBtn" class="btn btn-success"><i class="bi bi-mic-fill"></i> Gravar</button>
          <button id="stopBtn" class="btn btn-danger" disabled><i class="bi bi-stop-fill"></i> Parar</button>
          <span id="timer">00:00</span>
        </div>
        <canvas id="visualizer" class="mb-3"></canvas>
        <div class="mb-4 text-center">
          <span class="text-muted">-- OU --</span>
        </div>
        <div class="mb-4">
          <label for="audioFile" class="form-label fw-bold visually-hidden">Envie um arquivo de áudio:</label>
          <input type="file" id="audioFile" class="form-control" accept="audio/*">
        </div>

        <hr>

        <h5 class="section-title">2. Processe o Áudio</h5>
        <div class="d-flex justify-content-center my-3">
          <button id="transcribeBtn" class="btn btn-primary px-5 btn-lg">
            <i class="bi bi-cpu-fill"></i> Transcrever e Resumir
            <span class="spinner-border spinner-border-sm spinner-beside d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>

        <hr>

        <h5 class="section-title">3. Resultados</h5>
        <div class="row flex-grow-1">
          <div class="col-12 col-md-6 mb-3 d-flex flex-column">
            <label for="transcription" class="form-label fw-bold">Transcrição:</label>
            <textarea id="transcription" class="form-control flex-grow-1" rows="10" readonly placeholder="A transcrição aparecerá aqui..."></textarea> </div>
          <div class="col-12 col-md-6 mb-3 d-flex flex-column">
            <label for="summary" class="form-label fw-bold">Resumo em Tópicos:</label>
            <textarea id="summary" class="form-control flex-grow-1" rows="10" readonly placeholder="O resumo em tópicos aparecerá aqui..."></textarea> </div>
        </div>

        <hr>

        <h5 class="section-title">4. Próximos Passos</h5>
        <div class="d-flex justify-content-center flex-wrap gap-2 mt-auto pt-3">
          <button id="downloadTranscriptionBtn" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Baixar Transcrição</button>
          <button id="downloadSummaryBtn" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Baixar Resumo</button>
          <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#activityModal">
            <i class="bi bi-journal-plus"></i> Gerar Atividade
          </button>
          <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#verifyModal">
            <i class="bi bi-check2-square"></i> Corrigir Atividade
          </button>
        </div>

      </div> </div> </div> <div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="activityModalLabel">Gerador de Atividades</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Crie atividades com base no resumo gerado.</p>
          <div class="mb-3">
            <label for="activityType" class="form-label fw-bold">1. Tipo de Atividade:</label>
            <select id="activityType" class="form-select">
              <option value="dissertativa">Questões Dissertativas</option>
              <option value="objetiva">Questões Objetivas</option>
            </select>
          </div>
          <div class="border p-3 rounded bg-light">
            <p class="fw-bold">2. Opções:</p>
            <div class="mb-3">
              <label for="difficulty" class="form-label">Dificuldade:</label>
              <select id="difficulty" class="form-select">
                <option value="iniciante">Iniciante</option>
                <option value="intermediario">Intermediário</option>
                <option value="avancado">Avançado</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="quantity" class="form-label">Quantidade:</label>
              <input type="number" id="quantity" class="form-control" value="5" min="1" max="20">
            </div>
            <div id="objectiveFormatGroup" class="d-none">
              <div class="mb-3">
                <label for="questionType" class="form-label">Formato (Objetiva):</label>
                <select id="questionType" class="form-select">
                  <option value="multipla escolha">Múltipla Escolha</option>
                  <option value="associar colunas">Associar Colunas</option>
                  <option value="verdadeiro ou falso">Verdadeiro ou Falso</option>
                  <option value="assinale a excecao">Assinale a Exceção</option>
                  <option value="completar as lacunas">Completar Lacunas</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="generateActivityBtn" class="btn btn-info">
            <i class="bi bi-magic"></i> Gerar PDF
            <span class="spinner-border spinner-border-sm spinner-beside d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="verifyModal" tabindex="-1" aria-labelledby="verifyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="verifyModalLabel">Verificador de Gabarito</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
           <p class="text-muted">Envie o gabarito e as respostas do aluno para correção automática.</p>
          <div class="mb-3">
            <label for="teacherKeyFile" class="form-label fw-bold">1. PDF do Professor:</label>
            <input type="file" id="teacherKeyFile" class="form-control" accept=".pdf">
            <div class="form-text">Envie o PDF com as respostas corretas.</div>
          </div>
          <div class="mb-3">
            <label for="studentSheetFile" class="form-label fw-bold">2. Imagem(ns) do Aluno:</label>
            <input type="file" id="studentSheetFile" class="form-control" accept="image/*" multiple>
            <div class="form-text">Envie uma ou mais fotos da(s) folha(s) preenchida(s).</div>
          </div>
          <hr>
          <div id="gradeResult" class="text-center mt-3">
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="verifyBtn" class="btn btn-warning">
            <i class="bi bi-clipboard2-check-fill"></i>Verificar Nota
            <span class="spinner-border spinner-border-sm spinner-beside d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
  </div>

<div class="modal fade" id="tutorialModal" tabindex="-1" aria-labelledby="tutorialModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tutorialModalLabel"><i class="bi bi-info-circle-fill me-2"></i>Como Usar o NeuroVoz</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <h6>Passo 1: Forneça o Áudio</h6>
        <ul>
          <li><strong>Gravando:</strong> Clique no botão verde <button class="btn btn-sm btn-success disabled"><i class="bi bi-mic-fill"></i>Gravar</button>. Fale o que desejar. Clique em <button class="btn btn-sm btn-danger disabled"><i class="bi bi-stop-fill"></i>Parar</button> quando terminar.</li>
          <li><strong>Enviando Arquivo:</strong> Clique em "Escolher arquivo", selecione um arquivo de áudio (MP3, WAV, etc.) do seu computador.</li>
        </ul>

        <hr>

        <h6>Passo 2: Processe o Áudio</h6>
        <ul>
          <li>Clique no botão azul <button class="btn btn-sm btn-primary disabled"><i class="bi bi-cpu-fill"></i>Transcrever e Resumir</button>.</li>
          <li>Aguarde o processamento. O texto aparecerá nas caixas "Transcrição" e "Resumo em Tópicos".</li>
        </ul>

        <hr>

        <h6>Passo 3: Use os Resultados</h6>
        <p>Com a transcrição e o resumo prontos, você pode:</p>
        <ul>
          <li><strong>Baixar:</strong> Use os botões <button class="btn btn-sm btn-outline-secondary disabled"><i class="bi bi-download"></i>Baixar Transcrição</button> ou <button class="btn btn-sm btn-outline-secondary disabled"><i class="bi bi-download"></i>Baixar Resumo</button> para salvar os textos em PDF.</li>
          <li><strong>Gerar Atividade:</strong> Clique em <button class="btn btn-sm btn-outline-info disabled"><i class="bi bi-journal-plus"></i>Gerar Atividade</button>, configure as opções (tipo, dificuldade, etc.) e clique em "Gerar PDF" para criar uma atividade baseada no resumo. Você receberá um arquivo .zip com a versão do aluno e a do professor (com gabarito).</li>
          <li><strong>Corrigir Atividade:</strong> Clique em <button class="btn btn-sm btn-outline-warning disabled"><i class="bi bi-check2-square"></i>Corrigir Atividade</button>, envie o PDF do professor e a(s) foto(s) da folha de respostas do aluno, e clique em "Verificar Nota" para obter a correção automática, (caso o aluno não ter responido desenhe um X GRANDE em vermelho ao lado).</li>
          
        </ul>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendi!</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;

    // --- Seletores de Elementos ---
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const transcribeBtn = document.getElementById("transcribeBtn");
    const downloadTranscriptionBtn = document.getElementById("downloadTranscriptionBtn");
    const downloadSummaryBtn = document.getElementById("downloadSummaryBtn");
    const timerElement = document.getElementById("timer");
    const audioFileInput = document.getElementById("audioFile");
    const transcriptionArea = document.getElementById("transcription");
    const summaryArea = document.getElementById("summary");
    const visualizer = document.getElementById("visualizer");
    const activityType = document.getElementById('activityType');
    const objectiveFormatGroup = document.getElementById('objectiveFormatGroup');
    const generateActivityBtn = document.getElementById('generateActivityBtn');
    const activityModalEl = document.getElementById('activityModal');
    const activityModal = new bootstrap.Modal(activityModalEl);
    const verifyBtn = document.getElementById('verifyBtn');
    const teacherKeyFileInput = document.getElementById('teacherKeyFile');
    const studentSheetFileInput = document.getElementById('studentSheetFile');
    const gradeResultDiv = document.getElementById('gradeResult');

    const tutorialBtn = document.getElementById('tutorialBtn');
    const tutorialModalEl = document.getElementById('tutorialModal');
    const tutorialModal = new bootstrap.Modal(tutorialModalEl);

    // --- Variáveis de Estado ---
    let mediaRecorder, recordedChunks = [], recordedBlob;
    let audioContext, analyser, source, dataArray;
    let isRecording = false, isPaused = false;
    let timerInterval, seconds = 0;

    // --- Funções Auxiliares (Feedback) ---
    function showSpinner(buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = true;
            const spinner = button.querySelector('.spinner-border');
            if (spinner) spinner.classList.remove('d-none');
        }
    }

    function hideSpinner(buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = false;
            const spinner = button.querySelector('.spinner-border');
            if (spinner) spinner.classList.add('d-none');
        }
    }

    // --- Funções de Gravação, Timer, Visualizador, Transcrição ---
    function startTimer() {
        timerInterval = setInterval(() => {
            seconds++;
            const min = String(Math.floor(seconds / 60)).padStart(2, "0");
            const sec = String(seconds % 60).padStart(2, "0");
            timerElement.textContent = `${min}:${sec}`;
        }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }
    function resetTimer() { clearInterval(timerInterval); seconds = 0; timerElement.textContent = "00:00"; }
    function drawVisualizer() {
        const ctx = visualizer.getContext("2d");
        const draw = () => {
            requestAnimationFrame(draw);
            if (!analyser) return;
            analyser.getByteTimeDomainData(dataArray);
            ctx.fillStyle = "#f1f1f1";
            ctx.fillRect(0, 0, visualizer.width, visualizer.height);
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#1e3c72";
            ctx.beginPath();
            const sliceWidth = visualizer.width * 1.0 / analyser.fftSize;
            let x = 0;
            for (let i = 0; i < analyser.fftSize; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * visualizer.height / 2;
                if (i === 0) { ctx.moveTo(x, y); } else { ctx.lineTo(x, y); }
                x += sliceWidth;
            }
            ctx.lineTo(visualizer.width, visualizer.height / 2);
            ctx.stroke();
        };
        draw();
    }
    recordBtn.addEventListener("click", async () => {
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 2048;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                drawVisualizer();
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = async () => {
                    transcriptionArea.value = "Convertendo para MP3...";
                    summaryArea.value = "";
                    try {
                        const webmBlob = new Blob(recordedChunks, { type: "audio/webm" });
                        const arrayBuffer = await webmBlob.arrayBuffer();
                        if (!audioContext || audioContext.state === 'closed') { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        const mp3Encoder = new lamejs.Mp3Encoder(1, audioBuffer.sampleRate, 128);
                        const pcmData = audioBuffer.getChannelData(0);
                        const samples = new Int16Array(pcmData.length);
                        for (let i = 0; i < pcmData.length; i++) { samples[i] = pcmData[i] * 32767; }
                        const mp3Chunks = [];
                        const chunkSize = 1152;
                        for (let i = 0; i < samples.length; i += chunkSize) {
                            const chunk = samples.subarray(i, i + chunkSize);
                            const mp3Chunk = mp3Encoder.encodeBuffer(chunk);
                            if (mp3Chunk.length > 0) { mp3Chunks.push(mp3Chunk); }
                        }
                        const finalMp3Chunk = mp3Encoder.flush();
                        if (finalMp3Chunk.length > 0) { mp3Chunks.push(finalMp3Chunk); }
                        const mp3Blob = new Blob(mp3Chunks, { type: 'audio/mpeg' });
                        recordedBlob = mp3Blob;
                        transcriptionArea.value = "Áudio pronto! Clique em 'Transcrever'.";
                    } catch (error) {
                        console.error("Erro ao converter áudio para MP3:", error);
                        transcriptionArea.value = "Falha na conversão do áudio.";
                        recordedBlob = new Blob(recordedChunks, { type: "audio/webm" });
                    } finally {
                        if(audioContext && audioContext.state !== 'closed') audioContext.close();
                    }
                };
                mediaRecorder.start();
                startTimer();
                isRecording = true;
                recordBtn.innerHTML = '<i class="bi bi-pause-fill"></i>Pausar';
                recordBtn.classList.replace("btn-success", "btn-warning");
                stopBtn.disabled = false;
            } catch (err) { alert("Não foi possível iniciar a gravação. Verifique as permissões do microfone."); }
        } else if (!isPaused) {
            mediaRecorder.pause(); stopTimer(); isPaused = true;
            recordBtn.innerHTML = '<i class="bi bi-play-fill"></i>Retomar';
            recordBtn.classList.replace("btn-warning", "btn-primary");
        } else {
            mediaRecorder.resume(); startTimer(); isPaused = false;
            recordBtn.innerHTML = '<i class="bi bi-pause-fill"></i>Pausar';
            recordBtn.classList.replace("btn-primary", "btn-warning");
        }
    });
    stopBtn.addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop(); stopTimer(); isRecording = false; isPaused = false;
            recordBtn.innerHTML = '<i class="bi bi-mic-fill"></i>Gravar';
            recordBtn.className = "btn btn-success";
            stopBtn.disabled = true; resetTimer();
        }
    });
    audioFileInput.addEventListener("change", (e) => {
        if (e.target.files[0]) {
             recordedBlob = e.target.files[0];
             transcriptionArea.value = `Arquivo "${recordedBlob.name}" selecionado. Clique em 'Transcrever'.`;
             summaryArea.value = "";
        }
    });
    transcribeBtn.addEventListener("click", () => {
        if (!recordedBlob) return alert("Grave ou envie um arquivo de áudio primeiro!");
        sendAudioForTranscription(recordedBlob);
    });
    async function sendAudioForTranscription(file) {
        const formData = new FormData();
        formData.append("audio", file);
        transcriptionArea.value = "Enviando áudio...";
        summaryArea.value = "";
        showSpinner('transcribeBtn');

        try {
            const API_URL = "https://voz-transcricao.onrender.com/transcribe-chunked"; // Sua URL
            const response = await fetch(API_URL, { method: "POST", body: formData });
            if (!response.ok) throw new Error(`Falha no envio: ${response.statusText}`);
            const { jobId } = await response.json();
            transcriptionArea.value = `Processando... (Aguarde)`;
            pollJobStatus(jobId);
        } catch (err) {
            transcriptionArea.value = `Erro: ${err.message}`;
            hideSpinner('transcribeBtn');
        }
    }
    function pollJobStatus(jobId) {
        const intervalId = setInterval(async () => {
            try {
                const statusResponse = await fetch(`https://voz-transcricao.onrender.com/status/${jobId}`); // Sua URL
                if (!statusResponse.ok) {
                    clearInterval(intervalId);
                    transcriptionArea.value = "Erro ao buscar status do trabalho.";
                    hideSpinner('transcribeBtn');
                    return;
                }
                const job = await statusResponse.json();

                if (job.status === "processing" || job.status === "summarizing") {
                    transcriptionArea.value = `Processando... ${job.progress ? job.progress.toFixed(0) + '%' : ''}`;
                } else if (job.status === "completed") {
                    clearInterval(intervalId);
                    transcriptionArea.value = job.transcription;
                    summaryArea.value = job.summary || "";
                    hideSpinner('transcribeBtn');
                } else if (job.status === "failed") {
                    clearInterval(intervalId);
                    transcriptionArea.value = `Falha no Processamento: ${job.error || 'Erro desconhecido'}`;
                    hideSpinner('transcribeBtn');
                }
            } catch (err) {
                clearInterval(intervalId);
                transcriptionArea.value = "Erro de comunicação ao verificar status.";
                hideSpinner('transcribeBtn');
            }
        }, 3000);
    }

    // --- Lógica do Gerador de Atividades ---
    activityType.addEventListener('change', () => {
        objectiveFormatGroup.classList.toggle('d-none', activityType.value !== 'objetiva');
    });
    generateActivityBtn.addEventListener("click", async () => {
        showSpinner('generateActivityBtn');
        const summaryText = summaryArea.value;
         if (!summaryText.trim()) {
              alert("É preciso ter um resumo para criar uma atividade!");
              hideSpinner('generateActivityBtn');
              return;
         }
        const options = {
            type: activityType.value,
            difficulty: document.getElementById('difficulty').value,
            quantity: document.getElementById('quantity').value,
        };
        if (options.type === 'objetiva') {
            options.questionType = document.getElementById('questionType').value;
        }

         try {
             const response = await fetch("https://voz-transcricao.onrender.com/generate-activity", { // Sua URL
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ summaryText, options }),
            });
            if (!response.ok) throw new Error('Falha no servidor ao gerar atividade.');

            const { activityText, answers } = await response.json();

            if (options.type === 'dissertativa' || !answers || answers.length === 0) {
                 if(options.type !== 'dissertativa') alert("Atenção: O gabarito não foi retornado. Apenas o PDF do aluno será gerado.");
                 const studentDoc = generatePdf("Atividade_Aluno", activityText, options, null);
                 if (studentDoc) studentDoc.save("Atividade_Aluno.pdf");
            } else {
                 await generatePdfsAndZip(activityText, answers, options);
            }
             activityModal.hide();
         } catch (error) {
              console.error("Erro ao gerar atividade:", error);
             alert("Ocorreu um erro ao gerar a atividade.");
         } finally {
              hideSpinner('generateActivityBtn');
         }
    });

    // --- Funções de Geração de PDF e ZIP ---
    async function generatePdfsAndZip(activityText, answers, options) {
        const studentDoc = generatePdf("Atividade para o Aluno", activityText, options, null);
        const teacherDoc = generatePdf("Gabarito para o Professor", activityText, options, answers);
        if (!studentDoc || !teacherDoc) {
             alert("Falha ao gerar um dos PDFs.");
             return;
        }
        const zip = new JSZip();
        zip.file("Atividade_Aluno.pdf", studentDoc.output('blob'));
        zip.file("Gabarito_Professor.pdf", teacherDoc.output('blob'));
        const zipBlob = await zip.generateAsync({ type: "blob" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = 'Atividades.zip';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }
    function drawAnswerSheet(doc, startY, questionCount, page, answers = null) {
        let cursorY = startY;
        const { pageHeight, margin } = page;
        const rowHeight = 10;
        const colWidth = 15;
        const circleRadius = 3.5;
        const options = ['A', 'B', 'C', 'D'];
        const startX = margin.left;

        if (cursorY + rowHeight + 5 > pageHeight - margin.bottom) {
            doc.addPage();
            cursorY = margin.top;
        }

        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text("Folha de Respostas", startX, cursorY);
        doc.setFont(undefined, 'normal');
        cursorY += rowHeight * 1.5;

        for (let i = 1; i <= questionCount; i++) {
            if (cursorY + rowHeight > pageHeight - margin.bottom) {
                doc.addPage();
                cursorY = margin.top;
            }
            doc.setFontSize(10);
            doc.text(`${i}.`, startX + 2, cursorY);

            options.forEach((option) => {
                const circleX = startX + 25 + (options.indexOf(option) * colWidth);
                const circleY = cursorY - circleRadius / 2;
                
                if (answers && answers[i - 1] && answers[i - 1] === option) {
                    doc.circle(circleX, circleY, circleRadius, 'F');
                } else {
                    doc.circle(circleX, circleY, circleRadius, 'S');
                }
                
                doc.text(option, circleX, circleY, { align: 'center', baseline: 'middle' });
            });
            cursorY += rowHeight;
        }
        return cursorY;
    }
    function generatePdf(title, text, options = {}, answers = null) {
        if (!text || !text.trim()) { // Verifica se text é null, undefined ou vazio
            console.error("Tentativa de gerar PDF sem texto válido.");
            return null;
        }

        const doc = new jsPDF();
        const page = {
            pageHeight: doc.internal.pageSize.getHeight(),
            pageWidth: doc.internal.pageSize.getWidth(),
            margin: { top: 20, bottom: 20, left: 15 }
        };
        let cursorY = page.margin.top;

        doc.setFontSize(16);
        doc.text(title, page.pageWidth / 2, cursorY, { align: 'center' });
        cursorY += 10;
        doc.setFontSize(11);
        const lines = doc.splitTextToSize(text, page.pageWidth - page.margin.left * 2);

        lines.forEach(line => {
            if (cursorY + 7 > page.pageHeight - page.margin.bottom) {
                doc.addPage();
                cursorY = page.margin.top;
            }
            doc.text(line, page.margin.left, cursorY);
            cursorY += 7;
        });

        if (options.type === 'objetiva' && options.quantity > 0) {
            cursorY += 10;
            drawAnswerSheet(doc, cursorY, parseInt(options.quantity), page, answers);
        }
        
        return doc;
    }

    // --- Funções de download simples ---
    downloadTranscriptionBtn.addEventListener("click", () => {
        const textToDownload = transcriptionArea.value; // Pega o valor atual
        if (!textToDownload || !textToDownload.trim()){
            alert("Não há transcrição para baixar.");
            return;
        }
        const doc = generatePdf("Transcricao", textToDownload, {});
        if (doc) doc.save("Transcricao.pdf");
    });
    downloadSummaryBtn.addEventListener("click", () => {
         const textToDownload = summaryArea.value; // Pega o valor atual
        if (!textToDownload || !textToDownload.trim()){
            alert("Não há resumo para baixar.");
            return;
        }
        const doc = generatePdf("Resumo", textToDownload, {});
        if (doc) doc.save("Resumo.pdf");
    });

    // --- Lógica do Verificador de Gabarito ---
    verifyBtn.addEventListener('click', async () => {
        showSpinner('verifyBtn');
        gradeResultDiv.innerHTML = '';
        const teacherFile = teacherKeyFileInput.files[0];
        const studentFiles = studentSheetFileInput.files;

         if (!teacherFile || studentFiles.length === 0) {
             alert('Por favor, envie o PDF do professor e pelo menos uma imagem do aluno.');
             hideSpinner('verifyBtn');
             return;
         }
         const formData = new FormData();
         formData.append('teacherKey', teacherFile);
         for (let i = 0; i < studentFiles.length; i++) {
             formData.append('studentSheet', studentFiles[i]);
         }

         try {
             const response = await fetch("https://voz-transcricao.onrender.com/verify-answers", { // Sua URL
                method: 'POST',
                body: formData,
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Falha no servidor.');
            }
            const { individualGrades } = await response.json();

            if (individualGrades && individualGrades.length > 0) {
                let resultsHtml = '<h5 class="text-success mb-3">Resultados Individuais:</h5>';
                resultsHtml += '<ul class="list-group text-start">';
                individualGrades.forEach(result => {
                    resultsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                      ${result.fileName}
                                      <span class="badge bg-${result.grade.startsWith('Erro') ? 'danger' : 'primary'} rounded-pill">${result.grade}</span>
                                    </li>`;
                });
                resultsHtml += '</ul>';
                gradeResultDiv.innerHTML = resultsHtml;
            } else {
                 gradeResultDiv.innerHTML = '<p class="text-warning">Nenhuma nota foi retornada.</p>';
            }
         } catch (error) {
              console.error("Erro ao verificar gabarito:", error);
             gradeResultDiv.innerHTML = `<p class="text-danger"><b>Erro:</b> ${error.message}</p>`;
         } finally {
              hideSpinner('verifyBtn');
         }
    });
    if (tutorialBtn) { // Verifica se o botão existe antes de adicionar o listener
        tutorialBtn.addEventListener('click', () => {
            tutorialModal.show(); // Mostra o modal de tutorial ao clicar
        });
    }

  </script>
</body>
</html>
